<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="using:ScryScreen.App.Controls"
  xmlns:views="using:ScryScreen.App.Views"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:ScryScreen.App.ViewModels"
        mc:Ignorable="d"
        x:Class="ScryScreen.App.Views.PortalOverlayWindow"
        x:DataType="vm:PortalWindowViewModel"
        Title="ScryPortalOverlay"
        Background="Transparent"
        TransparencyLevelHint="Transparent"
        Topmost="False"
        ShowActivated="False"
        ShowInTaskbar="False"
        SystemDecorations="None"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        WindowStartupLocation="Manual">

  <!-- Overlay window is only shown over native video (HWND) to allow effects above it. -->
  <controls:QuakeShakeDecorator
      QuakeEnabled="{Binding OverlayEffects.QuakeEnabled}"
      QuakeIntensity="{Binding OverlayEffects.QuakeIntensity}"
      QuakeTrigger="{Binding OverlayEffects.QuakeTrigger}"
      EmitAudioEvents="{Binding IsShowingVideo}"
      AudioPortalNumber="{Binding PortalNumber}">

    <Grid IsHitTestVisible="False">
      <controls:OverlayEffectsLayer
          RainEnabled="{Binding OverlayEffects.RainEnabled}"
          RainIntensity="{Binding OverlayEffects.RainIntensity}"
          SnowEnabled="{Binding OverlayEffects.SnowEnabled}"
          SnowIntensity="{Binding OverlayEffects.SnowIntensity}"
          AshEnabled="{Binding OverlayEffects.AshEnabled}"
          AshIntensity="{Binding OverlayEffects.AshIntensity}"
          FireEnabled="{Binding OverlayEffects.FireEnabled}"
          FireIntensity="{Binding OverlayEffects.FireIntensity}"
          SandEnabled="{Binding OverlayEffects.SandEnabled}"
          SandIntensity="{Binding OverlayEffects.SandIntensity}"
          FogEnabled="{Binding OverlayEffects.FogEnabled}"
          FogIntensity="{Binding OverlayEffects.FogIntensity}"
          SmokeEnabled="{Binding OverlayEffects.SmokeEnabled}"
          SmokeIntensity="{Binding OverlayEffects.SmokeIntensity}"
          EmitAudioEvents="{Binding IsShowingVideo}"
          AudioPortalNumber="{Binding PortalNumber}"
          IsHitTestVisible="False" />

      <!-- Map Master overlay (below hourglass/dice) -->
      <Grid IsVisible="{Binding IsShowingMapMaster}" IsHitTestVisible="False">
        <Grid Opacity="{Binding MapMaster.PlayerMaskOpacity}">
          <Border IsVisible="{Binding MapMaster.IsSolidBlackMask}"
                  Background="Black">
            <Border.OpacityMask>
              <Binding Path="MapMaster.MaskBitmap" Converter="{StaticResource ImageBrushFromImageConverter}" />
            </Border.OpacityMask>
          </Border>

          <Image IsVisible="{Binding !MapMaster.IsSolidBlackMask}"
                 Source="{Binding MapMaster.MaskTexture}"
                 Stretch="Fill">
            <Image.OpacityMask>
              <Binding Path="MapMaster.MaskBitmap" Converter="{StaticResource ImageBrushFromImageConverter}" />
            </Image.OpacityMask>
          </Image>
        </Grid>
      </Grid>

      <!-- Keep hourglass visible above effects and Map Master -->
      <Grid IsVisible="{Binding IsShowingHourglass}" IsHitTestVisible="False">
        <views:HourglassPortalView DataContext="{Binding Hourglass}" />
      </Grid>

      <Grid IsVisible="{Binding IsShowingDiceRoller}" IsHitTestVisible="False">
        <views:DiceRollerPortalView DataContext="{Binding DiceRoller}" />
      </Grid>

      <!-- Identify overlay (needed because this window sits above the native video surface) -->
      <Border IsVisible="{Binding IsIdentifyOverlayVisible}"
              Background="#AA000000">
        <TextBlock Text="{Binding PortalNumber}"
                   Foreground="White"
                   FontSize="220"
                   FontWeight="Black"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center" />
      </Border>
    </Grid>
  </controls:QuakeShakeDecorator>
</Window>
