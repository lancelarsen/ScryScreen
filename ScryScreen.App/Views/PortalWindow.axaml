<Window xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:controls="using:ScryScreen.App.Controls"
  xmlns:views="using:ScryScreen.App.Views"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:ScryScreen.App.ViewModels"
        mc:Ignorable="d"
        x:Class="ScryScreen.App.Views.PortalWindow"
        x:DataType="vm:PortalWindowViewModel"
        Title="ScryPortal"
        Background="Black"
        Topmost="False"
        ShowActivated="False"
        SystemDecorations="None"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        WindowStartupLocation="Manual">

  <Border Background="Black">
    <controls:QuakeShakeDecorator
        QuakeEnabled="{Binding OverlayEffects.QuakeEnabled}"
        QuakeIntensity="{Binding OverlayEffects.QuakeIntensity}"
        QuakeTrigger="{Binding OverlayEffects.QuakeTrigger}"
      EmitAudioEvents="{Binding IsShowingVideo, Converter={StaticResource InverseBooleanConverter}}"
        AudioPortalNumber="{Binding PortalNumber}">
      <!-- All portal output (hidden => true blackout) -->
      <Grid IsVisible="{Binding IsContentVisible}">
      <!-- Assigned image (after setup) -->
      <Border x:Name="ImageHost"
          IsVisible="{Binding IsShowingImage}"
          Background="Black"
          ClipToBounds="True">
        <Canvas x:Name="ImageCanvas">
          <Image x:Name="ContentImage"
                 Source="{Binding ContentImage}"
                 Stretch="Fill" />
        </Canvas>
      </Border>

      <!-- Assigned video (after setup) -->
      <Border x:Name="VideoHost"
              IsVisible="{Binding IsShowingVideo}"
              Background="Black"
              ClipToBounds="True">
        <Canvas x:Name="VideoCanvas">
          <controls:VlcVideoHost x:Name="ContentVideo"
                                 MediaPlayer="{Binding VideoPlayer}" />
        </Canvas>
      </Border>

      <!-- Assigned text (after setup, when no image/video) -->
      <TextBlock
        IsVisible="{Binding IsShowingNonIdleText}"
        Text="{Binding ContentTitle}"
        Foreground="#E8D9B6"
        FontSize="48"
        FontWeight="SemiBold"
        TextAlignment="Center"
        HorizontalAlignment="Center"
        VerticalAlignment="Center" />

      <!-- Idle state: show the logo instead of the literal word "Idle" -->
      <Image IsVisible="{Binding IsShowingIdleLogo}"
             Source="avares://ScryScreen.App/Assets/Images/scry_logo_black.png"
             Stretch="Uniform"
             MaxHeight="520"
             HorizontalAlignment="Center"
             VerticalAlignment="Center" />

      <!-- Setup mode: persistent until first assignment -->
                  <Image IsVisible="{Binding IsSetup}"
                    Source="avares://ScryScreen.App/Assets/Images/scry_logo_black.png"
                    Stretch="Uniform"
                    MaxHeight="520"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center" />

                <!-- Map Master reveal mask (below Hourglass/Initiative/Dice) -->
                <Grid IsVisible="{Binding IsShowingMapMaster}" IsHitTestVisible="False">
                  <Grid Opacity="{Binding MapMaster.PlayerMaskOpacity}">
                    <Border IsVisible="{Binding MapMaster.IsSolidBlackMask}"
                            Background="Black">
                      <Border.OpacityMask>
                        <Binding Path="MapMaster.MaskBitmap" Converter="{StaticResource ImageBrushFromImageConverter}" />
                      </Border.OpacityMask>
                    </Border>

                    <Image IsVisible="{Binding !MapMaster.IsSolidBlackMask}"
                           Source="{Binding MapMaster.MaskTexture}"
                           Stretch="Fill">
                      <Image.OpacityMask>
                        <Binding Path="MapMaster.MaskBitmap" Converter="{StaticResource ImageBrushFromImageConverter}" />
                      </Image.OpacityMask>
                    </Image>
                  </Grid>
                </Grid>

        <!-- Overlay effects (rain/fog/smoke/snow/ash/sand/lightning) -->
      <controls:OverlayEffectsLayer
          RainEnabled="{Binding OverlayEffects.RainEnabled}"
          RainIntensity="{Binding OverlayEffects.RainIntensity}"
          SnowEnabled="{Binding OverlayEffects.SnowEnabled}"
          SnowIntensity="{Binding OverlayEffects.SnowIntensity}"
          AshEnabled="{Binding OverlayEffects.AshEnabled}"
          AshIntensity="{Binding OverlayEffects.AshIntensity}"
          FireEnabled="{Binding OverlayEffects.FireEnabled}"
          FireIntensity="{Binding OverlayEffects.FireIntensity}"
          SandEnabled="{Binding OverlayEffects.SandEnabled}"
          SandIntensity="{Binding OverlayEffects.SandIntensity}"
          FogEnabled="{Binding OverlayEffects.FogEnabled}"
          FogIntensity="{Binding OverlayEffects.FogIntensity}"
          SmokeEnabled="{Binding OverlayEffects.SmokeEnabled}"
          SmokeIntensity="{Binding OverlayEffects.SmokeIntensity}"
          LightningEnabled="{Binding OverlayEffects.LightningEnabled}"
          LightningIntensity="{Binding OverlayEffects.LightningIntensity}"
          LightningTrigger="{Binding OverlayEffects.LightningTrigger}"
          EmitAudioEvents="{Binding IsShowingVideo, Converter={StaticResource InverseBooleanConverter}}"
          AudioPortalNumber="{Binding PortalNumber}"
          IsHitTestVisible="False" />

      <!-- Keep hourglass visible above effects -->
      <Grid IsVisible="{Binding IsShowingHourglass}" IsHitTestVisible="False">
        <views:HourglassPortalView DataContext="{Binding Hourglass}" />
      </Grid>

      <!-- Initiative tracker above Map Master -->
      <Grid IsVisible="{Binding IsShowingInitiative}">
        <views:InitiativeTrackerPortalView DataContext="{Binding Initiative}" />
      </Grid>

      <!-- Dice Roller overlay -->
      <Grid IsVisible="{Binding IsShowingDiceRoller}" IsHitTestVisible="False">
        <views:DiceRollerPortalView DataContext="{Binding DiceRoller}"
                                   HorizontalAlignment="Stretch"
                                   VerticalAlignment="Stretch" />
      </Grid>

      <!-- Identify overlay -->
      <Border IsVisible="{Binding IsIdentifyOverlayVisible}"
              Background="#AA000000">
        <TextBlock Text="{Binding PortalNumber}"
                   Foreground="White"
                   FontSize="220"
                   FontWeight="Black"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center" />
      </Border>
      </Grid>
    </controls:QuakeShakeDecorator>
  </Border>
</Window>
