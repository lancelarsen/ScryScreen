<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ScryScreen.App.ViewModels"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             xmlns:beh="using:ScryScreen.App.Behaviors"
             mc:Ignorable="d"
             x:Class="ScryScreen.App.Views.InitiativeTrackerView"
             x:DataType="vm:InitiativeTrackerViewModel">

  <UserControl.Styles>
    <Style Selector="TextBlock">
      <Setter Property="FontSize" Value="12" />
    </Style>

    <!-- Make text entry feel consistent and centered in this table -->
    <Style Selector="TextBox">
      <Setter Property="FontSize" Value="12" />
      <Setter Property="Background" Value="#0A0F18" />
      <Setter Property="BorderBrush" Value="{DynamicResource ScryBorder}" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="CornerRadius" Value="8" />
      <Setter Property="Padding" Value="10,4" />
      <Setter Property="VerticalContentAlignment" Value="Center" />
    </Style>

    <!-- Gold focus instead of the default/red highlight -->
    <Style Selector="TextBox:focus">
      <Setter Property="BorderBrush" Value="{DynamicResource ScryAccent}" />
    </Style>
    <Style Selector="TextBox:focus-within">
      <Setter Property="BorderBrush" Value="{DynamicResource ScryAccent}" />
    </Style>

    <Style Selector="ComboBox">
      <Setter Property="FontSize" Value="12" />
      <Setter Property="Background" Value="#0A0F18" />
      <Setter Property="BorderBrush" Value="{DynamicResource ScryBorder}" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="CornerRadius" Value="8" />
      <Setter Property="Padding" Value="10,4" />
      <Setter Property="VerticalContentAlignment" Value="Center" />
    </Style>

    <Style Selector="ComboBox:focus">
      <Setter Property="BorderBrush" Value="{DynamicResource ScryAccent}" />
    </Style>
    <Style Selector="ComboBox:focus-within">
      <Setter Property="BorderBrush" Value="{DynamicResource ScryAccent}" />
    </Style>

    <!-- FluentTheme uses a template border; override it explicitly to avoid red focus outlines -->
    <Style Selector="TextBox:focus /template/ Border">
      <Setter Property="BorderBrush" Value="{DynamicResource ScryAccent}" />
    </Style>
    <Style Selector="TextBox:focus-within /template/ Border">
      <Setter Property="BorderBrush" Value="{DynamicResource ScryAccent}" />
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,*" RowSpacing="10">
      <Border Grid.Row="0"
              IsVisible="{Binding ShowConditionsConfiguration}"
              Background="#0A0F18"
              BorderBrush="{DynamicResource ScryBorder}"
              BorderThickness="1"
              CornerRadius="10"
              Padding="12">
        <Grid RowDefinitions="Auto,*" RowSpacing="10">
          <TextBlock Grid.Row="0"
                     Text="Conditions Configuration"
                     Foreground="{DynamicResource ScryTextMuted}"
                     FontWeight="SemiBold" />

          <!-- Editor -->
          <Grid Grid.Row="1" RowDefinitions="Auto,Auto" RowSpacing="10">
            <!-- Row 0: condition selector + swatches + RGB + Save/Delete icons -->
            <Grid Grid.Row="0"
              ColumnDefinitions="Auto,*,Auto,Auto,Auto,Auto,Auto,Auto"
                  ColumnSpacing="10"
                  VerticalAlignment="Center">
              <ComboBox Grid.Column="0"
                        MinWidth="200"
                        ItemsSource="{Binding ConditionLibraryItems}"
                        SelectedItem="{Binding SelectedCondition, Mode=TwoWay}">
                <ComboBox.ItemTemplate>
                  <DataTemplate x:DataType="vm:ConditionDefinitionViewModel" x:CompileBindings="False">
                    <Grid ColumnDefinitions="22,*" ColumnSpacing="8" Margin="2,4">
                      <Border Grid.Column="0" Width="16" Height="16" CornerRadius="8" Background="{Binding ColorBrush}" />
                      <TextBlock Grid.Column="1" Text="{Binding DisplayName}" Foreground="{DynamicResource ScryTextMuted}" />
                    </Grid>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>

              <ItemsControl Grid.Column="1"
                            ItemsSource="{Binding ConditionColorSwatchesPicker}"
                            IsEnabled="{Binding HasSelectedCondition}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel ItemSpacing="6" LineSpacing="6" />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:ColorSwatchViewModel" x:CompileBindings="False">
                    <Button Classes="circleSmall" Width="28" Height="28"
                            Command="{Binding DataContext.SelectColorSwatchForSelectedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding .}">
                      <Border Width="16" Height="16" CornerRadius="8" Background="{Binding Brush}" />
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>

                    <TextBlock Grid.Column="2"
                   Text="RGB"
                   Foreground="{DynamicResource ScryTextMuted}"
                   VerticalAlignment="Center" />

                    <TextBox Grid.Column="3" Width="54" TextAlignment="Center" Text="{Binding SelectedColorRText, Mode=TwoWay}" IsEnabled="{Binding HasSelectedCondition}" beh:NumericTextBoxBehavior.IsNumericOnly="True" beh:NumericTextBoxBehavior.AllowNegative="False" />
                    <TextBox Grid.Column="4" Width="54" TextAlignment="Center" Text="{Binding SelectedColorGText, Mode=TwoWay}" IsEnabled="{Binding HasSelectedCondition}" beh:NumericTextBoxBehavior.IsNumericOnly="True" beh:NumericTextBoxBehavior.AllowNegative="False" />
                    <TextBox Grid.Column="5" Width="54" TextAlignment="Center" Text="{Binding SelectedColorBText, Mode=TwoWay}" IsEnabled="{Binding HasSelectedCondition}" beh:NumericTextBoxBehavior.IsNumericOnly="True" beh:NumericTextBoxBehavior.AllowNegative="False" />

                    <Button Grid.Column="6"
                      Classes="circleSmall"
                      ToolTip.Tip="Save"
                      IsEnabled="{Binding HasSelectedCondition}"
                      Command="{Binding SaveSelectedConditionEditsCommand}">
                <i:Icon Value="mdi-content-save" FontSize="18"
                        Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
              </Button>

                    <Button Grid.Column="7"
                      Classes="circleSmall"
                      ToolTip.Tip="Delete Custom"
                      IsEnabled="{Binding CanDeleteSelectedCondition}"
                      Command="{Binding DeleteSelectedCustomConditionCommand}">
                <i:Icon Value="mdi-delete" FontSize="18" Foreground="{DynamicResource ScryDanger}" />
              </Button>
            </Grid>

            <!-- Row 1: add custom condition name + save icon -->
            <Grid Grid.Row="1" ColumnDefinitions="Auto,*" ColumnSpacing="8" VerticalAlignment="Center">
              <TextBlock Grid.Column="0"
                         Text="Custom Condition"
                         Foreground="{DynamicResource ScryTextMuted}"
                         VerticalAlignment="Center" />

              <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <TextBox Watermark="Name"
                         Width="200"
                         Text="{Binding NewCustomConditionNameText, Mode=TwoWay}" />

                <Button Classes="circleSmall"
                        ToolTip.Tip="Add Custom Condition"
                        Command="{Binding AddCustomConditionFromSelectedCommand}">
                  <i:Icon Value="mdi-content-save" FontSize="18"
                          Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                </Button>
              </StackPanel>
            </Grid>
          </Grid>
        </Grid>
      </Border>

      <ScrollViewer Grid.Row="1"
                    MaxHeight="520"
                    HorizontalScrollBarVisibility="Disabled"
                    VerticalScrollBarVisibility="Auto">
        <ItemsControl ItemsSource="{Binding Entries}">
          <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:InitiativeEntryViewModel" x:CompileBindings="False">
                      <Grid ColumnDefinitions="24,36,Auto,Auto,Auto,Auto,3*,Auto,5*,36,36,36" RowDefinitions="Auto,Auto" ColumnSpacing="4" RowSpacing="0" Margin="0,0,0,2" VerticalAlignment="Center">
              <Image Source="avares://ScryScreen.App/Assets/Images/Gem Transparent.png"
                Width="20"
                Height="20"
                Opacity="0.9"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                IsVisible="{Binding IsActive}" />

              <Button Grid.Column="1"
                      Classes="circleSmall"
                    Foreground="{DynamicResource ScryAccent}"
                      ToolTip.Tip="Roll d20 + Mod"
                      Command="{Binding DataContext.RollInitiativeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      CommandParameter="{Binding .}">
                  <i:Icon Value="mdi-dice-d20" FontSize="18"
                  Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
              </Button>

              <TextBox Grid.Column="2" Width="42"
                       HorizontalAlignment="Center"
                       TextAlignment="Center"
                       HorizontalContentAlignment="Center"
                       Watermark="Init"
                       beh:NumericTextBoxBehavior.IsNumericOnly="True"
                       beh:SelectAllOnFocusBehavior.IsEnabled="True"
                       Text="{Binding Initiative, Mode=TwoWay}" />

              <TextBox Grid.Column="3"
                       Width="42"
                       HorizontalAlignment="Center"
                       TextAlignment="Center"
                       HorizontalContentAlignment="Center"
                       Watermark="Mod"
                       beh:NumericTextBoxBehavior.IsNumericOnly="True"
                       beh:SelectAllOnFocusBehavior.IsEnabled="True"
                       Text="{Binding Mod, Mode=TwoWay}" />

              <TextBox Grid.Column="4"
                       Width="56"
                       HorizontalAlignment="Center"
                       TextAlignment="Center"
                       HorizontalContentAlignment="Center"
                       Watermark="Max"
                       beh:NumericTextBoxBehavior.IsNumericOnly="True"
                       beh:NumericTextBoxBehavior.AllowNegative="False"
                       beh:SelectAllOnFocusBehavior.IsEnabled="True"
                       Text="{Binding MaxHp, Mode=TwoWay}" />

              <TextBox Grid.Column="5"
                       Width="56"
                       HorizontalAlignment="Center"
                       TextAlignment="Center"
                       HorizontalContentAlignment="Center"
                       Watermark="HP"
                       beh:NumericTextBoxBehavior.IsNumericOnly="True"
                       beh:NumericTextBoxBehavior.AllowNegative="False"
                       beh:SelectAllOnFocusBehavior.IsEnabled="True"
                       Text="{Binding CurrentHp, Mode=TwoWay}" />

              <TextBox Grid.Column="6" Watermark="Name" Text="{Binding Name, Mode=TwoWay}" />

              <!-- Add-condition controls stay on the main row to keep scanning fast. -->
              <StackPanel Grid.Column="7" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                <ComboBox Width="140"
                          ItemsSource="{Binding DataContext.ConditionDefinitions, RelativeSource={RelativeSource AncestorType=UserControl}}"
                          SelectedItem="{Binding SelectedConditionToAdd, Mode=TwoWay}">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding DisplayName}" TextTrimming="CharacterEllipsis" Foreground="{DynamicResource ScryTextMuted}" />
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>

                <ComboBox Width="64"
                          ItemsSource="{Binding DataContext.ConditionDurationOptions, RelativeSource={RelativeSource AncestorType=UserControl}}"
                          SelectedItem="{Binding SelectedConditionRoundsToAdd, Mode=TwoWay}"
                          IsVisible="{Binding SelectedConditionToAdd.IsManualOnly, Converter={StaticResource InverseBooleanConverter}}">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding ., TargetNullValue=-}" Foreground="{DynamicResource ScryTextMuted}" />
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>

                <Button Classes="circleSmall"
                        ToolTip.Tip="Add condition"
                        Command="{Binding DataContext.AddConditionToEntryCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                        CommandParameter="{Binding .}">
                  <i:Icon Value="mdi-plus" FontSize="18"
                    Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                </Button>
              </StackPanel>

              <TextBox Grid.Column="8" Watermark="GM Notes" Text="{Binding Notes, Mode=TwoWay}" />

              <ToggleButton Grid.Column="9" Classes="circleSmall noAccent" IsChecked="{Binding IsHidden, Mode=TwoWay}" ToolTip.Tip="Show/Hide">
                <Grid>
                  <i:Icon IsVisible="{Binding !IsHidden}" Value="mdi-eye" FontSize="18" Foreground="{DynamicResource ScrySuccess}" />
                  <i:Icon IsVisible="{Binding IsHidden}" Value="mdi-eye-off" FontSize="18" Foreground="{DynamicResource ScryDanger}" />
                </Grid>
              </ToggleButton>

              <Button Grid.Column="10"
                      Classes="circleSmall"
                      ToolTip.Tip="Delete"
                      Command="{Binding DataContext.RemoveEntryCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      CommandParameter="{Binding .}">
                <i:Icon Value="mdi-delete" FontSize="18" Foreground="{DynamicResource ScryDanger}" />
              </Button>

              <Button Grid.Column="11"
                      Classes="circleSmall"
                      IsVisible="{Binding IsLast}"
                      ToolTip.Tip="Add Row"
                      Command="{Binding DataContext.AddEntryCommand, RelativeSource={RelativeSource AncestorType=UserControl}}">
                <i:Icon Value="mdi-plus" FontSize="18"
                  Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
              </Button>

              <!-- Applied conditions shown beneath the row, starting under Init -->
              <ScrollViewer Grid.Row="1"
                            Grid.Column="2"
                            Grid.ColumnSpan="7"
                            MaxHeight="36"
                            HorizontalScrollBarVisibility="Disabled"
                            VerticalScrollBarVisibility="Auto"
                            IsVisible="{Binding Conditions.Count, Converter={StaticResource NotZeroToBoolConverter}}"
                            Margin="0,4,0,0"
                            ClipToBounds="True">
                <ItemsControl ItemsSource="{Binding Conditions}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <WrapPanel ItemSpacing="6" LineSpacing="6" />
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:InitiativeEntryConditionViewModel" x:CompileBindings="False">
                      <Button Background="{Binding ColorBrush}"
                              Opacity="0.95"
                              BorderBrush="{DynamicResource ScryBorder}"
                              BorderThickness="1"
                              CornerRadius="8"
                              Padding="10,4"
                              Height="28"
                              HorizontalContentAlignment="Stretch"
                              VerticalContentAlignment="Center"
                              ToolTip.Tip="Remove"
                              Command="{Binding DataContext.RemoveConditionFromEntryCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                              CommandParameter="{Binding .}">
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10" VerticalAlignment="Center">
                          <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <TextBlock Text="{Binding Name}"
                                       Foreground="#000000"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center" />

                            <Border IsVisible="{Binding HasTimer}"
                                    Background="#FFFFFF"
                                    Opacity="0.65"
                                    CornerRadius="8"
                                    Padding="6,0"
                                    VerticalAlignment="Center">
                              <TextBlock Text="{Binding RoundsRemaining}"
                                         Foreground="#000000"
                                         FontSize="10"
                                         FontWeight="Black"
                                         VerticalAlignment="Center" />
                            </Border>
                          </StackPanel>

                          <i:Icon Grid.Column="1"
                                  Value="mdi-close"
                                  FontSize="14"
                                  Foreground="#000000"
                                  VerticalAlignment="Center"
                                  HorizontalAlignment="Right" />
                        </Grid>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </Grid>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>

      <!-- Empty state helper text (like Media) -->
      <Border IsVisible="{Binding IsEmpty}"
              Background="#0A0F18"
              BorderBrush="{DynamicResource ScryBorder}"
              BorderThickness="1"
              CornerRadius="10"
              Padding="16"
              HorizontalAlignment="Left"
              VerticalAlignment="Top"
              Margin="0,10,0,0"
              MaxWidth="560">
        <Grid ColumnDefinitions="Auto,Auto,*" ColumnSpacing="8" RowDefinitions="Auto">
          <TextBlock Grid.Column="0"
                     Text="Click"
                     Foreground="{DynamicResource ScryTextMuted}"
                     VerticalAlignment="Center" />

          <Button Grid.Column="1"
                  Classes="circleSmall"
                  Command="{Binding AddEntryCommand}"
                  VerticalAlignment="Center"
                  ToolTip.Tip="Add">
              <i:Icon Value="mdi-plus" FontSize="18"
                Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
          </Button>

          <TextBlock Grid.Column="2"
                     Text="to add initiative tracker rows."
                     Foreground="{DynamicResource ScryTextMuted}"
                     VerticalAlignment="Center"
                     TextWrapping="Wrap" />
        </Grid>
      </Border>
    </Grid>
</UserControl>
